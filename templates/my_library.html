{% extends "base.html" %}

{% block title %}My Library{% endblock %}

{% block extra_css %}
<style>
        .modal-xl {
            max-width: 90%;
        }
        .modal-content {
            height: 90vh;
            display: flex;
            flex-direction: column;
        }
        .modal-body {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 1rem;
        }
        #lyricsForm {
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        .lyrics-container {
            flex-grow: 1;
            overflow-y: auto;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        #lyrics {
            flex: 1;
            resize: none;
        }
        .form-label {
            margin-bottom: 0.25rem;
        }
        .form-group {
            display: flex;
            flex-direction: column;
            flex: 1;
        }
        .track-card {
            transition: transform 0.3s;
            cursor: pointer;
        }
        .track-card:hover {
            transform: scale(1.05);
        }
        .card-img-top {
            height: 150px;
            object-fit: cover;
        }
        #track-detail {
            position: fixed;
            top: 0;
            right: -50%;
            width: 50%;
            height: 100%;
            background: white;
            transition: right 0.3s;
            overflow-y: auto;
            box-shadow: -5px 0 15px rgba(0,0,0,0.1);
        }
        .track-detail-content {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        #track-detail.show {
            right: 0;
        }
        .content-shift {
            transition: margin-right 0.3s;
        }
        .content-shift.active {
            margin-right: 50%;
        }
        #close-detail {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
        }
        .track-image-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 1rem;
        }
        .track-image {
            max-width: 250px;
            max-height: 250px;
            object-fit: cover;
            border-radius: 5px;
        }
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .status-label {
            position: absolute;
            bottom: 5px;
            right: 5px;
            padding: 2px 5px;
            font-size: 0.7rem;
            border-radius: 3px;
        }
        .status-translated {
            background-color: #28a745;
            color: white;
        }
        .status-needs-translation {
            background-color: #ffc107;
            color: black;
        }
        .status-needs-lyrics {
            background-color: #dc3545;
            color: white;
        }
</style>
{% endblock %}


{% block content %}
<div class="container mt-5 content-shift" id="main-content">
    <h1 class="mb-4">My Library</h1>
    <div class="row row-cols-2 row-cols-md-4 row-cols-lg-5 g-3" id="library-content">
        <!-- Library content will be dynamically added here -->
    </div>
</div>

<div id="track-detail"></div>

<!-- Modal for editing lyrics -->
<div class="modal fade" id="lyricsModal" tabindex="-1" aria-labelledby="lyricsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="lyricsModalLabel">Edit Lyrics</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="lyricsForm">
                    <input type="hidden" id="trackId" name="trackId">
                    <div class="form-group">
                        <label for="lyrics" class="form-label">Lyrics</label>
                        <textarea class="form-control" id="lyrics" name="lyrics"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="saveLyrics">Save changes</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}


{% block extra_js %}
<script>
        $(document).ready(function() {
            loadLibrary();

            $(document).on('click', '.track-card', function() {
                var trackId = $(this).data('track-id');
                showTrackDetail(trackId);
            });

            $(document).on('click', '#close-detail', function() {
                $('#track-detail').removeClass('show');
                $('#main-content').removeClass('active');
            });

            $(document).on('click', '#edit-lyrics', function() {
                var trackId = $(this).data('track-id');
                var lyrics = $(this).data('lyrics');
                $('#trackId').val(trackId);
                $('#lyrics').val(lyrics);
                $('#lyricsModal').modal('show');
            });

            $(document).on('click', '#saveLyrics', function() {
                var trackId = $('#trackId').val();
                var lyrics = $('#lyrics').val();
                var isTranslated = $(this).data('is-translated');
                saveLyrics(trackId, lyrics, isTranslated);
            });

            $(document).on('click', '#translate-lyrics', function() {
                var trackId = $(this).data('track-id');
                showLoadingOverlay();
                translateLyrics(trackId);
            });

            $(document).on('click', '#edit-translated-lyrics', function() {
                var trackId = $(this).data('track-id');
                var lyrics = $(this).data('lyrics');
                openLyricsModal(trackId, lyrics, true);
            });

            $(document).on('click', '#regenerate-translation', function() {
                var trackId = $(this).data('track-id');
                regenerateTranslation(trackId);
            });
        });

        function loadLibrary() {
            $.get('/api/library', function(data) {
                var libraryHtml = '';
                data.forEach(function(track) {
                    var statusLabel = getStatusLabel(track);
                    libraryHtml += `
                        <div class="col">
                            <div class="card h-100 track-card position-relative" data-track-id="${track.id}">
                                <img src="${track.image_url}" class="card-img-top" alt="${track.title}">
                                <div class="card-body p-2">
                                    <h6 class="card-title mb-0 text-truncate" title="${track.title}">${track.title}</h6>
                                    <p class="card-text mb-0 small text-muted text-truncate" title="${track.artist}">${track.artist}</p>
                                </div>
                                ${statusLabel}
                            </div>
                        </div>
                    `;
                });
                $('#library-content').html(libraryHtml);
            });
        }


        function showTrackDetail(trackId) {
            $.get('/api/library/' + trackId, function(data) {
                var detailHtml = `
                    <button class="btn btn-secondary" id="close-detail">&times;</button>
                    <div class="track-detail-content p-4">
                        <div class="track-image-container">
                            <img src="${data.image_url}" class="track-image" alt="${data.title}">
                        </div>
                        <h2 class="text-center">${data.title}</h2>
                        <h4 class="text-center mb-3">${data.artist}</h4>
                        <ul class="nav nav-tabs" id="lyricsTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="original-tab" data-bs-toggle="tab" data-bs-target="#original" type="button" role="tab" aria-controls="original" aria-selected="true">Original</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="translated-tab" data-bs-toggle="tab" data-bs-target="#translated" type="button" role="tab" aria-controls="translated" aria-selected="false">Translated</button>
                            </li>
                        </ul>
                        <div class="tab-content flex-grow-1" id="lyricsTabContent">
                        <div class="tab-pane fade show active h-100" id="original" role="tabpanel" aria-labelledby="original-tab">
                            <div class="lyrics-container">
                                ${data.lyrics ?
                                    `<p style="white-space: pre-line;">${data.lyrics}</p>` :
                                    `<p>No lyrics available.</p>`
                                }
                                <button id="edit-lyrics" class="btn btn-primary mt-2" data-track-id="${data.id}" data-lyrics="${data.lyrics || ''}">Edit Lyrics</button>
                            </div>
                        </div>
                        <div class="tab-pane fade h-100" id="translated" role="tabpanel" aria-labelledby="translated-tab">
                            <div class="lyrics-container">
                                ${data.translated_lyrics ?
                                    `<p style="white-space: pre-line;">${data.translated_lyrics}</p>
                                    <div class="button-group">
                                        <button id="edit-translated-lyrics" class="btn btn-primary" data-track-id="${data.id}" data-lyrics="${data.translated_lyrics}">Edit Lyrics</button>
                                        <button id="regenerate-translation" class="btn btn-secondary" data-track-id="${data.id}">Regenerate</button>
                                    </div>` :
                                    `<button id="translate-lyrics" class="btn btn-primary" data-track-id="${data.id}">AI 번역하기</button>`
                                }
                            </div>
                        </div>
                    </div>
                `;
                $('#track-detail').html(detailHtml).addClass('show');
                $('#main-content').addClass('active');
            });
        }

        function openLyricsModal(trackId, lyrics, isTranslated = false) {
            $('#trackId').val(trackId);
            $('#lyrics').val(lyrics);
            $('#lyricsModalLabel').text(isTranslated ? 'Edit Translated Lyrics' : 'Edit Original Lyrics');
            $('#saveLyrics').data('is-translated', isTranslated);
            $('#lyricsModal').modal('show');
        }

        function saveLyrics(trackId, lyrics, isTranslated) {
            var endpoint = isTranslated ? '/api/library/update_translated_lyrics' : '/api/library/update_lyrics';
            $.post(endpoint, { track_id: trackId, lyrics: lyrics }, function(response) {
                if (response.success) {
                    $('#lyricsModal').modal('hide');
                    showTrackDetail(trackId);
                } else {
                    alert('Failed to save lyrics');
                }
            });
        }

        function translateLyrics(trackId) {
            $.post('/api/library/translate', { track_id: trackId }, function(response) {
                hideLoadingOverlay();
                if (response.success) {
                    $('#translated .lyrics-container').html(`
                        <p style="white-space: pre-line;">${response.translated_lyrics}</p>
                    `);
                } else {
                    alert('Failed to translate lyrics');
                }
            });
        }

        function regenerateTranslation(trackId) {
            showLoadingOverlay();
            $.post('/api/library/regenerate_translation', { track_id: trackId }, function(response) {
                hideLoadingOverlay();
                if (response.success) {
                    showTrackDetail(trackId);
                } else {
                    alert('Failed to regenerate translation');
                }
            });
        }
        function showLoadingOverlay() {
            $('<div class="loading-overlay"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>')
                .appendTo('#track-detail');
        }

        function hideLoadingOverlay() {
            $('.loading-overlay').remove();
        }
        function getStatusLabel(track) {
            if (track.translated_lyrics) {
                return '<span class="status-label status-translated">번역됨</span>';
            } else if (track.lyrics) {
                return '<span class="status-label status-needs-translation">번역필요</span>';
            } else {
                return '<span class="status-label status-needs-lyrics">가사필요</span>';
            }
        }
    </script>
{% endblock %}